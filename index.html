<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁâôÂë®Ê≤ªÁôÇÁ¥ÄÈåÑË°®</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Export Tools -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyA9ZQx9eGD51K-VfUCuMddYWrsg2W9k16o",
            authDomain: "tooth-treat--charteasy.firebaseapp.com",
            projectId: "tooth-treat--charteasy",
            storageBucket: "tooth-treat--charteasy.firebasestorage.app",
            messagingSenderId: "675075241868",
            appId: "1:675075241868:web:22d36417ed0d0f35ed08a9",
            measurementId: "G-GKM48Y8JKR"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.firestoreModules = { doc, setDoc, getDoc, onSnapshot, collection, query, orderBy, limit };
        } catch(e) {
            console.warn("Firebase Init Error", e);
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500;700&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #525252; 
            color: #000000; 
            margin: 0;
            padding: 20px;
        }

        /* --- Ê†∏ÂøÉÁΩÆ‰∏≠Ê®£Âºè --- */
        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            text-align: center;
            overflow: hidden; 
        }

        /* --- Áº∫ÁâôÊ®£Âºè --- */
        .missing-overlay {
            position: relative;
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(150, 150, 150, 0.5) 5px,
                rgba(150, 150, 150, 0.5) 10px
            );
            color: #fff;
        }
        .tooth-cell.missing {
            color: #d1d5db;
            background-color: #e5e7eb;
            position: relative;
        }
        .tooth-cell.missing::after {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(0, 0, 0, 0.2) 5px,
                rgba(0, 0, 0, 0.2) 10px
            );
            pointer-events: none;
        }

        /* --- A4 ÂÆπÂô® --- */
        .a4-landscape-paper {
            width: 100%;
            max-width: 297mm; 
            min-height: 210mm;
            background: white;
            margin: 0 auto 30px auto;
            padding: 10mm;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            box-sizing: border-box;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* --- Ë°®Ê†ºÊ®£Âºè --- */
        .perio-table { 
            border-collapse: collapse; 
            width: 100%; 
            table-layout: fixed; 
            font-size: 11px;
        }
        
        .perio-table th, .perio-table td { 
            border: 1px solid #000; 
            padding: 0 !important; 
            height: 38px; 
            vertical-align: middle;
            position: relative; 
        }

        .tooth-row { 
            height: 28px; 
            background-color: #000; 
            color: #fff; 
            font-weight: bold;
            font-size: 13px;
        }

        .pd-input { 
            width: 100%; 
            height: 100%; 
            text-align: center; 
            border: none; 
            background: transparent; 
            font-size: 13px; 
            font-weight: 700; 
            font-family: 'Roboto Mono', monospace; 
            color: #000;
            padding: 0; 
            margin: 0;
            display: block; /* Safari Fix: avoid flex on input */
        }
        .pd-input:focus { outline: 2px solid #2563eb; background-color: #eff6ff; }
        .val-danger { color: #dc2626; font-weight: 900; }

        .header-main-inner {
            display: flex;
            align-items: center; 
            justify-content: center; 
            width: 100%;
            height: 100%;
        }
        .header-main-inner span {
            display: inline-block;
            transform: rotate(90deg);
            white-space: nowrap;
            font-size: 11px;     
            font-weight: 900;
        }

        .header-sub { 
            background-color: #f3f4f6; 
            font-weight: 700; 
            color: #000000; 
            font-size: 11px; 
            white-space: normal;
            line-height: 1.1;
            padding: 0 1px;
        }

        .patient-info-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .patient-info-table td {
            padding: 2px 4px;
        }
        
        /* Furcation */
        .furc-container { display: flex; flex-direction: row; width: 100%; height: 100%; }
        .furc-subcell { flex: 1; border-right: 1px solid #d1d5db; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; cursor: pointer; color: #9ca3af; height: 100%; }
        .furc-subcell:last-child { border-right: none; }
        .furc-subcell.val-active { color: #000000; font-size: 12px; font-weight: 900; }
        .furc-subcell:hover { background-color: #f3f4f6; }

        /* Mobility */
        .cycle-cell { cursor: pointer; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; user-select: none; color: #000; }
        .cycle-cell:hover { background-color: #e5e7eb; }
        .cycle-val-3 { color: #dc2626; background-color: #fee2e2; } 

        /* Plaque */
        .indicator-row { display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 2px; height: 100%; width: 100%; }
        .indicator-box { width: 12px; height: 12px; border: 1px solid #9ca3af; border-radius: 2px; cursor: pointer; }
        .plaque-active { background-color: #2563eb; border-color: #2563eb; }

        /* Plaque Compact Mode overrides */
        .plaque-compact .perio-table td { height: 24px; font-size: 10px; }
        .plaque-compact .tooth-row { height: 20px; font-size: 11px; }
        
        @media print {
            @page { size: landscape; margin: 0; }
            body { background: white; padding: 0; }
            .no-print { display: none !important; }
            .a4-landscape-paper { box-shadow: none; margin: 0; width: 100%; max-width: none; height: 100vh; page-break-after: always; padding: 5mm 10mm; }
            .a4-landscape-paper:last-child { page-break-after: auto; }
            .chart-container { overflow: visible !important; } 
        }

        @media screen and (max-width: 768px) {
            body { padding: 10px; background-color: #f3f4f6; }
            .a4-landscape-paper { width: 100%; max-width: none; min-height: auto; padding: 10px; margin-bottom: 20px; box-shadow: none; border-radius: 8px; }
            .chart-container { overflow-x: auto; border: 1px solid #ccc; }
            .perio-table { min-width: 900px; }
            .pd-input { font-size: 16px !important; }
            .clinic-footer { font-size: 14px; margin-top: 10px; }
        }
        
        .tab-btn { padding: 10px 20px; font-weight: bold; border-radius: 8px 8px 0 0; cursor: pointer; border: 1px solid transparent; margin-right: 4px; font-size: 14px; }
        .tab-btn.active { background-color: white; color: #000; border-color: transparent; z-index: 10; margin-bottom: -1px; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); }
        .tab-btn.inactive { background-color: #404040; color: #d1d5db; border-color: transparent; }
        .summary-box { margin-top: 5px; margin-bottom: 10px; border: 2px solid #000; padding: 5px; background-color: #f8fafc; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; }
        .summary-item { display: flex; flex-direction: column; align-items: center; min-width: 80px; }
        .summary-label { font-size: 11px; color: #4b5563; font-weight: 700; margin-bottom: 2px; }
        .summary-value { font-size: 16px; font-weight: 900; color: #000; }
        .summary-value.highlight { color: #dc2626; }
        .clinic-footer { margin-top: 10px; padding-top: 10px; border-top: 2px solid #000; text-align: center; font-size: 18px; font-weight: 900; color: #000; letter-spacing: 3px; width: 100%; }
        .header-control { display: flex; gap: 5px; align-items: center; font-size: 11px; font-weight: normal; background: rgba(255,255,255,0.2); padding: 1px 4px; border-radius: 4px; }
        .header-radio { cursor: pointer; display: flex; align-items: center; gap: 2px; }

        .plaque-record-unit { margin-bottom: 10mm; padding-bottom: 5mm; border-bottom: 2px dashed #ccc; }
        .plaque-record-unit:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 999; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; max-width: 95vw; max-height: 95vh; overflow: auto; display: flex; flex-col; gap: 4; }
        .preview-img { max-width: 100%; border: 1px solid #ccc; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.9); color: white; padding: 12px 24px; border-radius: 50px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 100; font-weight: 500; }
        .toast.show { opacity: 1; }

        /* Login Modal */
        .login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(31, 41, 55, 0.95); display:flex; justify-content:center; align-items:center; z-index: 2000; }
        .login-box { background:white; padding:30px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.5); text-align:center; width: 90%; max-width: 500px; }
        .clinic-btn {
            display: block; width: 100%; padding: 12px; margin-bottom: 10px;
            background-color: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 8px;
            text-align: center; font-weight: bold; color: #374151; font-size: 16px;
            transition: all 0.2s;
        }
        .clinic-btn:hover { background-color: #e5e7eb; border-color: #d1d5db; }
        .clinic-btn.selected { background-color: #dbeafe; border-color: #2563eb; color: #1e40af; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo } = React;

        const Teeth18to11 = [18, 17, 16, 15, 14, 13, 12, 11];
        const Teeth21to28 = [21, 22, 23, 24, 25, 26, 27, 28];
        const Teeth48to41 = [48, 47, 46, 45, 44, 43, 42, 41];
        const Teeth31to38 = [31, 32, 33, 34, 35, 36, 37, 38];
        const allTeeth = [...Teeth18to11, ...Teeth21to28, ...Teeth48to41, ...Teeth31to38];

        // --- Improved ROC Date Picker Component (Fixes typing issue) ---
        const ROCDatePicker = ({ value, onChange, theme = 'dark', isExporting = false }) => {
            // Local state to handle typing buffer
            const [localY, setLocalY] = useState('');
            const [localM, setLocalM] = useState('');
            const [localD, setLocalD] = useState('');

            // Sync from props when external value changes (e.g. file load)
            useEffect(() => {
                if (!value) {
                    setLocalY(''); setLocalM(''); setLocalD('');
                } else {
                    const parts = value.split('-');
                    if (parts.length === 3) {
                        const roc = parseInt(parts[0]) - 1911;
                        setLocalY(roc > 0 ? roc.toString() : '');
                        setLocalM(parts[1]);
                        setLocalD(parts[2]);
                    }
                }
            }, [value]);

            if (isExporting) {
                const displayDate = (localY && localM && localD) ? `${localY}/${localM}/${localD}` : '';
                // Changed to always text-black based on feedback for plaque table visibility
                const textClass = theme === 'light' ? 'text-white' : 'text-black';
                return <span className={`${textClass} font-bold text-sm whitespace-nowrap`}>{displayDate}</span>;
            }

            const handleLocalChange = (part, val) => {
                const numericVal = val.replace(/[^0-9]/g, '');
                
                // Update local state first (UI responsiveness)
                if (part === 'y') setLocalY(numericVal);
                if (part === 'm') setLocalM(numericVal);
                if (part === 'd') setLocalD(numericVal);

                // Use the *new* value for calculation, current state for others
                const nextY = part === 'y' ? numericVal : localY;
                const nextM = part === 'm' ? numericVal : localM;
                const nextD = part === 'd' ? numericVal : localD;

                // Try to sync to parent if all fields have data
                if (nextY && nextM && nextD) {
                    // Simple validation
                    let mInt = parseInt(nextM);
                    let dInt = parseInt(nextD);
                    if (mInt > 12) mInt = 12; // Basic clamping
                    if (dInt > 31) dInt = 31;

                    const adYear = parseInt(nextY) + 1911;
                    const paddedM = mInt.toString().padStart(2, '0');
                    const paddedD = dInt.toString().padStart(2, '0');
                    
                    onChange(`${adYear}-${paddedM}-${paddedD}`);
                } else if (!nextY && !nextM && !nextD) {
                    // Only clear if fully empty to avoid accidental data loss
                    onChange('');
                }
            };

            const inputClass = `bg-transparent border-b text-center focus:outline-none p-0 m-0 ${theme === 'light' ? 'border-white text-white placeholder-gray-300' : 'border-gray-400 text-gray-900 placeholder-gray-400'}`;
            const slashClass = `mx-0.5 font-bold ${theme === 'light' ? 'text-white' : 'text-gray-900'}`;

            return (
                <div className="flex items-center justify-center whitespace-nowrap">
                    <input type="tel" className={`${inputClass} w-8`} placeholder="YYY" value={localY} onChange={(e) => handleLocalChange('y', e.target.value)} maxLength="3" />
                    <span className={slashClass}>/</span>
                    <input type="tel" className={`${inputClass} w-6`} placeholder="MM" value={localM} onChange={(e) => handleLocalChange('m', e.target.value)} maxLength="2" />
                    <span className={slashClass}>/</span>
                    <input type="tel" className={`${inputClass} w-6`} placeholder="DD" value={localD} onChange={(e) => handleLocalChange('d', e.target.value)} maxLength="2" />
                </div>
            );
        };

        const createToothData = () => ({
            missing: false,
            mobility: { initial: 0, reeval: 0 },
            furcation: { initial: { D: 0, B: 0, M: 0 }, reeval: { D: 0, B: 0, M: 0 } },
            buccal: { pd: { initial: ['', '', ''], reeval: ['', '', ''] } },
            palatal: { pd: { initial: ['', '', ''], reeval: ['', '', ''] } }
        });

        const createPlaqueToothData = (isMissing = false) => ({
            buccal: [false, false, false],
            palatal: [false, false, false],
            missing: isMissing
        });

        const initialData = {};
        allTeeth.forEach(id => initialData[id] = createToothData());

        const createNewPlaqueRecord = (referenceData) => {
            const teethData = {};
            allTeeth.forEach(id => {
                const isMissing = referenceData ? referenceData[id].missing : false;
                teethData[id] = createPlaqueToothData(isMissing);
            });
            return {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                data: teethData
            };
        };

        const chunkArray = (arr, size) => {
            const results = [];
            for (let i = 0; i < arr.length; i += size) {
                results.push(arr.slice(i, i + size));
            }
            return results;
        };

        const App = () => {
            const [clinicName, setClinicName] = useState('');
            const [customClinicName, setCustomClinicName] = useState('');
            const [isStarted, setIsStarted] = useState(false);
            const [fileHandle, setFileHandle] = useState(null);

            const [data, setData] = useState(initialData);
            const [plaqueRecords, setPlaqueRecords] = useState([createNewPlaqueRecord(initialData)]);
            const [patientInfo, setPatientInfo] = useState({ name: '', id: '', idNumber: '', gender: '', dob: '', age: '', doctor: '', datePre: new Date().toISOString().split('T')[0], datePost: '' });
            const [activeTab, setActiveTab] = useState('chart');
            const [toastMsg, setToastMsg] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [startUpper, setStartUpper] = useState('18');
            const [startLower, setStartLower] = useState('48');
            const [previewImg, setPreviewImg] = useState(null);
            const [isExporting, setIsExporting] = useState(false);

            const chartRef = useRef(null);

            // ËΩâÊèõÊó•ÊúüÁÇ∫Ê∞ëÂúãÂπ¥Ê†ºÂºè (ÂÉÖÁî®ÊñºÁ¥îÊñáÂ≠óÈ°ØÁ§∫)
            const formatDateToROC = (dateStr) => {
                if (!dateStr) return '';
                const parts = dateStr.split('-');
                if (parts.length !== 3) return dateStr;
                const year = parseInt(parts[0]) - 1911;
                const rocYear = year < 0 ? year : String(year).padStart(3, '0');
                return `${rocYear}/${parts[1]}/${parts[2]}`;
            };

            const perioStats = useMemo(() => {
                let totalTeeth = 0, deepTeethInit = 0, improvedTeeth = 0;
                allTeeth.forEach(id => {
                    const tooth = data[id];
                    if (tooth.missing) return;
                    totalTeeth++;
                    const checkDeep = (arr) => arr.some(v => v && parseInt(v) >= 5);
                    if (checkDeep(tooth.buccal.pd.initial) || checkDeep(tooth.palatal.pd.initial)) deepTeethInit++;
                    const checkImprove = (initArr, reArr) => {
                        for(let i=0; i<3; i++) {
                            const init = parseInt(initArr[i]) || 0;
                            const re = parseInt(reArr[i]) || 0;
                            if (init > 0 && re > 0 && (init - re) >= 2) return true;
                        }
                        return false;
                    };
                    if (checkImprove(tooth.buccal.pd.initial, tooth.buccal.pd.reeval) || checkImprove(tooth.palatal.pd.initial, tooth.palatal.pd.reeval)) improvedTeeth++;
                });
                let improvementRate = deepTeethInit > 0 ? ((improvedTeeth / deepTeethInit) * 100).toFixed(1) : 0;
                return { totalTeeth, deepTeethInit, improvedTeeth, improvementRate };
            }, [data]);

            const getPlaqueStats = (record) => {
                let totalTeeth = 0, totalSites = 0, plaqueSites = 0;
                allTeeth.forEach(id => {
                    if (record.data[id].missing) return; 
                    totalTeeth++; totalSites += 6;
                    const toothPlaque = record.data[id];
                    plaqueSites += toothPlaque.buccal.filter(Boolean).length + toothPlaque.palatal.filter(Boolean).length;
                });
                const index = totalSites > 0 ? ((plaqueSites / totalSites) * 100).toFixed(1) : 0;
                return { totalTeeth, totalSites, plaqueSites, index };
            };

            const getUpperTeeth = () => startUpper === '18' ? [...Teeth18to11, ...Teeth21to28] : [...[...Teeth21to28].reverse(), ...[...Teeth18to11].reverse()];
            const getLowerTeeth = () => startLower === '48' ? [...Teeth48to41, ...Teeth31to38] : [...[...Teeth31to38].reverse(), ...[...Teeth48to41].reverse()];

            const showToast = (msg) => { setToastMsg(msg); setTimeout(() => setToastMsg(''), 3000); };

            const handleStart = () => {
                let finalName = clinicName;
                if (clinicName === 'other') {
                    if (!customClinicName.trim()) {
                        alert("Ë´ãËº∏ÂÖ•Ë®∫ÊâÄÂêçÁ®±");
                        return;
                    }
                    finalName = customClinicName.trim();
                }
                if (!finalName) {
                    alert("Ë´ãÈÅ∏ÊìáË®∫ÊâÄ");
                    return;
                }
                if (clinicName === 'other') setClinicName(finalName); 
                setIsStarted(true);
            };

            const handleOpenFile = async () => {
                try {
                    const [handle] = await window.showOpenFilePicker({
                        types: [{ description: 'JSON Data', accept: {'application/json': ['.json']} }],
                        multiple: false
                    });
                    const file = await handle.getFile();
                    const text = await file.text();
                    const json = JSON.parse(text);

                    if(json.info) setPatientInfo(json.info);
                    if(json.data) setData(json.data);
                    if(json.plaqueRecords) setPlaqueRecords(json.plaqueRecords);
                    if(json.clinicName) {
                         setClinicName(json.clinicName);
                         setCustomClinicName(json.clinicName);
                    }
                    
                    setFileHandle(handle);
                    setIsStarted(true);
                    showToast(`üìÇ Â∑≤ÈñãÂïü: ${file.name}`);
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error(err);
                        alert("ÁÑ°Ê≥ïÈñãÂïüÊ™îÊ°àÔºåË´ãÁ¢∫Ë™çÁÄèË¶ΩÂô®ÊîØÊè¥Êàñ‰ΩøÁî®ÂåØÂÖ•ÂäüËÉΩ„ÄÇ");
                    }
                }
            };

            const handleSaveFile = async (saveAs = false) => {
                try {
                    const exportData = {
                        info: patientInfo,
                        data: data,
                        plaqueRecords: plaqueRecords,
                        clinicName: clinicName,
                        lastModified: new Date().toISOString()
                    };
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], {type : 'application/json'});
                    let handle = fileHandle;
                    if (saveAs || !handle) {
                        const suggestedName = `${patientInfo.id}_${patientInfo.name || 'record'}.json`;
                        handle = await window.showSaveFilePicker({
                            suggestedName: suggestedName,
                            types: [{ description: 'JSON Data', accept: {'application/json': ['.json']} }],
                        });
                        setFileHandle(handle);
                    }
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    showToast("üíæ ÂÑ≤Â≠òÊàêÂäüÔºÅ");
                } catch (err) {
                    if (err.name !== 'AbortError') { console.error(err); alert("ÂÑ≤Â≠òÂ§±Êïó"); }
                }
            };

            const handleNewRecord = () => {
                if (confirm("Á¢∫ÂÆöË¶ÅÈñãÊñ∞ÁóÖÊ≠∑ÂóéÔºüÁõÆÂâçÁöÑË≥áÊñôÂ∞áË¢´Ê∏ÖÁ©∫„ÄÇ")) {
                    setFileHandle(null);
                    setData(initialData);
                    setPlaqueRecords([createNewPlaqueRecord(initialData)]);
                    setPatientInfo({ name: '', id: '', idNumber: '', gender: '', dob: '', age: '', doctor: '', datePre: new Date().toISOString().split('T')[0], datePost: '' });
                    setIsStarted(false);
                }
            };

            const downloadPDF = async (format) => {
                const { jsPDF } = window.jspdf;
                const selector = '.a4-landscape-paper';
                const element = document.querySelector(selector);
                if(!element) { alert('Ë´ãÂÖàÂàáÊèõÂà∞Ë¶ÅÂàóÂç∞ÁöÑÈ†ÅÈù¢'); return; }

                setIsExporting(true); // Switch to text mode for export
                const savedStartUpper = startUpper;
                const savedStartLower = startLower;
                setStartUpper('18');
                setStartLower('48');

                setTimeout(async () => {
                    const originalStyle = { width: element.style.width, maxWidth: element.style.maxWidth, overflow: element.style.overflow };
                    element.style.width = '297mm'; element.style.maxWidth = 'none'; element.style.overflow = 'visible';
                    window.scrollTo(0, 0); 

                    try {
                        const captureScale = format.startsWith('jpg') ? 4 : 3;
                        const canvas = await html2canvas(element, { scale: captureScale, useCORS: true, backgroundColor: "#ffffff", windowWidth: 1200 });
                        
                        let outputCanvas = canvas;
                        if (format.startsWith('jpg')) {
                            let targetWidth = (format === 'jpg_a5') ? 2480 : 3508;
                            let targetHeight = (format === 'jpg_a5') ? 1748 : 2480;
                            const tempCanvas = document.createElement('canvas');
                            tempCanvas.width = targetWidth; tempCanvas.height = targetHeight;
                            const ctx = tempCanvas.getContext('2d');
                            ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, targetWidth, targetHeight);
                            ctx.drawImage(canvas, 0, 0, targetWidth, targetHeight);
                            outputCanvas = tempCanvas;
                        }

                        const imgData = outputCanvas.toDataURL('image/jpeg', 0.95);
                        
                        if (format.startsWith('jpg')) {
                            const win = window.open();
                            if (win) {
                                win.document.write('<html><head><title>È†êË¶Ω</title></head><body style="margin:0;display:flex;justify-content:center;background:#525252;"><img src="' + imgData + '" style="max-width:100%;"></body></html>');
                                win.document.close();
                            } else alert('Ë´ãÂÖÅË®±ÂΩàÂá∫Ë¶ñÁ™ó');
                        } else {
                            let pdf = new jsPDF('l', 'mm', format === 'a5' ? 'a5' : 'a4');
                            let w = format === 'a5' ? 210 : 297;
                            let h = format === 'a5' ? 148 : 210;
                            pdf.addImage(imgData, 'JPEG', 0, 0, w, h);
                            window.open(URL.createObjectURL(pdf.output('blob')), '_blank');
                        }
                    } catch (err) {
                        console.error("Export failed", err);
                    } finally {
                        element.style.width = originalStyle.width;
                        element.style.maxWidth = originalStyle.maxWidth;
                        element.style.overflow = originalStyle.overflow;
                        setStartUpper(savedStartUpper);
                        setStartLower(savedStartLower);
                        setIsExporting(false); 
                    }
                }, 100);
            };

            const toggleMissing = (id) => {
                setData(prev => {
                    const newMissing = !prev[id].missing;
                    // Sync to first plaque record
                    setPlaqueRecords(prevRecords => {
                        if (prevRecords.length === 0) return prevRecords;
                        const newRecords = [...prevRecords];
                        const firstRecord = { ...newRecords[0] };
                        if (firstRecord.data && firstRecord.data[id]) {
                            firstRecord.data = {
                                ...firstRecord.data,
                                [id]: {
                                    ...firstRecord.data[id],
                                    missing: newMissing
                                }
                            };
                            newRecords[0] = firstRecord;
                        }
                        return newRecords;
                    });
                    return { ...prev, [id]: { ...prev[id], missing: newMissing } };
                });
            };

            const togglePlaqueMissing = (recordIndex, id) => {
                setPlaqueRecords(prev => {
                    const newList = [...prev];
                    const record = { ...newList[recordIndex] };
                    const toothData = { ...record.data[id] };
                    toothData.missing = !toothData.missing;
                    record.data = { ...record.data, [id]: toothData };
                    newList[recordIndex] = record;
                    return newList;
                });
            };
            
            const handleCycleClick = (id, cat, sub, field) => {
                if (data[id].missing) return; 
                setData(prev => {
                    const newData = { ...prev };
                    const tooth = { ...newData[id] };
                    const cycle = (c) => (!c ? 1 : (c === 3 ? 0 : c + 1));
                    if (cat === 'mobility') tooth.mobility[sub] = cycle(tooth.mobility[sub]);
                    else if (cat === 'furcation') tooth.furcation[sub][field] = cycle(tooth.furcation[sub][field]);
                    newData[id] = tooth;
                    return newData;
                });
            };

            const updatePD = (id, surface, stage, index, value) => {
                if (data[id].missing) return;
                if (value.length > 1) value = value.slice(-1); 
                if (!/^[0-9]?$/.test(value)) return;
                setData(prev => {
                    const newData = { ...prev };
                    newData[id][surface].pd[stage] = [...prev[id][surface].pd[stage]];
                    newData[id][surface].pd[stage][index] = value;
                    return newData;
                });
                if (value.length === 1) handleNavigate(id, surface, stage, index, 'next');
            };

            const addNewPlaqueRecord = () => {
                setPlaqueRecords(prev => [...prev, createNewPlaqueRecord(data)]);
                setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 100);
            };

            const updatePlaqueDate = (recordIndex, newDate) => {
                setPlaqueRecords(prev => {
                    const newList = [...prev];
                    newList[recordIndex] = { ...newList[recordIndex], date: newDate };
                    return newList;
                });
            };
            
            // Random Plaque Generator
            const handleRandomPlaque = (recordIndex, level) => {
                setPlaqueRecords(prev => {
                    const newList = [...prev];
                    const record = { ...newList[recordIndex] };
                    const newData = { ...record.data };
                    
                    let threshold = 0.2;
                    if (level === 'medium') threshold = 0.5;
                    if (level === 'high') threshold = 0.8;
                    if (level === 'verylow') threshold = 0.1; // 10%

                    allTeeth.forEach(id => {
                        if (newData[id].missing) return; // Skip missing

                        const newBuccal = [
                            Math.random() < threshold,
                            Math.random() < threshold,
                            Math.random() < threshold
                        ];
                        const newPalatal = [
                            Math.random() < threshold,
                            Math.random() < threshold,
                            Math.random() < threshold
                        ];

                        newData[id] = {
                            ...newData[id],
                            buccal: newBuccal,
                            palatal: newPalatal
                        };
                    });

                    record.data = newData;
                    newList[recordIndex] = record;
                    return newList;
                });
            };

            const togglePlaque = (recordIndex, id, surface, index) => {
                if (plaqueRecords[recordIndex].data[id].missing) return;
                setPlaqueRecords(prev => {
                    const newList = [...prev];
                    const record = { ...newList[recordIndex] };
                    const toothData = { ...record.data[id] };
                    const newArr = [...toothData[surface]];
                    newArr[index] = !newArr[index];
                    toothData[surface] = newArr;
                    record.data = { ...record.data, [id]: toothData };
                    newList[recordIndex] = record;
                    return newList;
                });
            };

            const handleFocus = (e) => {
                e.target.select();
                if (window.innerWidth <= 768) setTimeout(() => e.target.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }), 100);
            };

            const handleNavigate = (currentId, surface, stage, index, direction) => {
                const upperOrder = getUpperTeeth();
                const lowerOrder = getLowerTeeth();
                const currentPath = upperOrder.includes(currentId) ? upperOrder : lowerOrder;
                const currIdx = currentPath.indexOf(currentId);
                const focusAndScroll = (id) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.focus();
                        if (window.innerWidth <= 768) setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }), 50);
                    }
                };
                if (direction === 'vertical') {
                    const nextStage = stage === 'initial' ? 'reeval' : 'initial';
                    focusAndScroll(`pd-${currentId}-${surface}-${nextStage}-${index}`);
                    return;
                }
                const dirVal = direction === 'next' ? 1 : -1;
                let nextIndex = index + dirVal;
                if (nextIndex >= 0 && nextIndex <= 2) {
                    focusAndScroll(`pd-${currentId}-${surface}-${stage}-${nextIndex}`);
                    return;
                }
                let scanIdx = currIdx + dirVal;
                while (scanIdx >= 0 && scanIdx < currentPath.length) {
                    const tid = currentPath[scanIdx];
                    if (!data[tid].missing) {
                        const targetIdx = direction === 'next' ? 0 : 2;
                        focusAndScroll(`pd-${tid}-${surface}-${stage}-${targetIdx}`);
                        return;
                    }
                    scanIdx += dirVal;
                }
            };

            const handleKeyDown = (e, currentId, surface, stage, index) => {
                if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Enter'].includes(e.key)) return;
                e.preventDefault();
                if (e.key === 'ArrowLeft') handleNavigate(currentId, surface, stage, index, 'prev');
                else if (e.key === 'ArrowRight' || e.key === 'Enter') handleNavigate(currentId, surface, stage, index, 'next');
                else if (e.key === 'ArrowUp' || e.key === 'ArrowDown') handleNavigate(currentId, surface, stage, index, 'vertical');
            };

            const renderMobilityCell = (id, sub) => {
                const val = data[id].mobility[sub];
                if (data[id].missing) return <div className="missing-overlay w-full h-full"></div>;
                return <div className={`cycle-cell ${val===3?'cycle-val-3':''}`} onClick={()=>handleCycleClick(id,'mobility',sub)}>{val===0?'':val}</div>;
            };

            const renderFurcationCell = (id, sub) => {
                const info = data[id].furcation[sub];
                if (data[id].missing) return <div className="missing-overlay w-full h-full"></div>;
                const idNum = parseInt(id);
                const noFurcationTeeth = [11, 12, 13, 21, 22, 23, 31, 32, 33, 34, 35, 41, 42, 43, 44, 45];
                if (noFurcationTeeth.includes(idNum)) return <div className="w-full h-full bg-gray-100 flex-center text-gray-300 text-xs">/</div>;
                
                if ([14, 15, 24, 25].includes(idNum)) {
                    return <div className="furc-container">{['M', 'D'].map(key => <div key={key} className={`furc-subcell ${info[key]===3?'cycle-val-3':''} ${info[key]>0?'val-active':''}`} onClick={()=>handleCycleClick(id, 'furcation', sub, key)}>{info[key]===0 ? key : info[key]}</div>)}</div>;
                }
                if ([36, 37, 38, 46, 47, 48].includes(idNum)) {
                    const configs = [{ label: 'B', key: 'B' }, { label: 'L', key: 'M' }];
                    return <div className="furc-container">{configs.map(cfg => <div key={cfg.label} className={`furc-subcell ${info[cfg.key]===3?'cycle-val-3':''} ${info[cfg.key]>0?'val-active':''}`} onClick={()=>handleCycleClick(id, 'furcation', sub, cfg.key)}>{info[cfg.key]===0 ? cfg.label : info[cfg.key]}</div>)}</div>;
                }
                return <div className="furc-container">{['D', 'B', 'M'].map(pos => <div key={pos} className={`furc-subcell ${info[pos]===3?'cycle-val-3':''} ${info[pos]>0?'val-active':''}`} onClick={()=>handleCycleClick(id,'furcation',sub,pos)}>{info[pos]===0?pos:info[pos]}</div>)}</div>;
            };

            const renderPDInputs = (id, surface, stage) => {
                const vals = data[id][surface].pd[stage];
                if (data[id].missing) return <div className="missing-overlay w-full h-full"></div>;
                return (
                    <div className="flex h-full">
                        {[0, 1, 2].map(i => (
                            <div key={i} className="flex-1 border-r last:border-r-0 border-gray-300 flex-center">
                                <input id={`pd-${id}-${surface}-${stage}-${i}`} className={`pd-input ${parseInt(vals[i])>=5?'val-danger':''}`} type="tel" inputMode="numeric" pattern="[0-9]*" maxLength="2" enterKeyHint="next" value={vals[i]} onChange={(e)=>updatePD(id, surface, stage, i, e.target.value)} onKeyDown={(e)=>handleKeyDown(e, id, surface, stage, i)} onFocus={handleFocus} autoComplete="off" />
                            </div>
                        ))}
                    </div>
                );
            };

            const renderPlaqueRow = (recordIndex, id, surface) => {
                const toothData = plaqueRecords[recordIndex].data[id];
                const vals = toothData ? toothData[surface] : [false, false, false];
                if (toothData.missing) return <div className="missing-overlay w-full h-full"></div>;
                return (
                    <div className="indicator-row">
                        {[0, 1, 2].map(i => <div key={i} className={`indicator-box ${vals[i]?'plaque-active':''}`} onClick={()=>togglePlaque(recordIndex, id, surface, i)} />)}
                    </div>
                );
            };

            const renderControls = (isUpper) => (
                <div className="header-control" data-html2canvas-ignore="true">
                    <span className="mr-2 opacity-80">Ëµ∑Âßã:</span>
                    <label className="header-radio"><input type="radio" checked={isUpper ? startUpper==='18' : startLower==='48'} onChange={()=> isUpper ? setStartUpper('18') : setStartLower('48')} /> {isUpper ? '18(Âè≥)' : '48(Âè≥)'}</label>
                    <label className="header-radio ml-3"><input type="radio" checked={isUpper ? startUpper==='28' : startLower==='38'} onChange={()=> isUpper ? setStartUpper('28') : setStartLower('38')} /> {isUpper ? '28(Â∑¶)' : '38(Â∑¶)'}</label>
                </div>
            );

            const renderPatientInfoHeader = () => (
                <table className="patient-info-table">
                    <tbody>
                        <tr>
                            <td width="15%">ÂßìÂêç: {patientInfo.name}</td>
                            <td width="15%">ÁóÖÊ≠∑Ëôü: {patientInfo.id}</td>
                            <td width="20%">Ë∫´ÂàÜË≠âÂ≠óËôü: {patientInfo.idNumber}</td>
                            <td width="10%">ÊÄßÂà•: {patientInfo.gender}</td>
                            <td width="15%">ÁîüÊó•: {formatDateToROC(patientInfo.dob)}</td>
                            <td width="5%">Âπ¥ÈΩ°: {patientInfo.age}</td>
                            <td width="20%">‰∏ªÊ≤ªÈÜ´Â∏´: {patientInfo.doctor}</td>
                        </tr>
                    </tbody>
                </table>
            );

            const renderPerioTab = () => (
                <div className="a4-landscape-paper">
                    <div className="text-center font-black text-2xl mb-2 border-b-4 border-black pb-1">PERIODONTAL TREATMENT CHART</div>
                    <div className="border-b-2 border-black mb-3 pb-2">
                        {renderPatientInfoHeader()}
                        <div className="px-2 font-bold text-sm flex gap-4">
                             <span>Ë°ìÂâçÊó•Êúü: {formatDateToROC(patientInfo.datePre)}</span>
                             <span>Ë°ìÂæåÊó•Êúü: {formatDateToROC(patientInfo.datePost)}</span>
                        </div>
                    </div>

                    <div className="chart-container">
                        <div className="bg-black text-white h-8 flex items-center px-2 border border-black text-sm justify-between">
                            <span>Maxilla (‰∏äÈ°é)</span>{renderControls(true)}
                        </div>
                        <table className="perio-table">
                            <colgroup><col className="col-header-main" /><col className="col-header-sub" />{getUpperTeeth().map(t => <col key={t} width="*" />)}</colgroup>
                            <tbody>
                                <tr className="border-thick-top"><td rowSpan="2" className="header-main"><div className="header-main-inner"><span>Mobility</span></div></td><td className="header-sub"><div className="flex-center">Ë°ìÂâç (Pre)</div></td>{getUpperTeeth().map(id => <td key={`mob-init-${id}`}>{renderMobilityCell(id, 'initial')}</td>)}</tr>
                                <tr><td className="header-sub"><div className="flex-center">Ë°ìÂæå (Post)</div></td>{getUpperTeeth().map(id => <td key={`mob-re-${id}`}>{renderMobilityCell(id, 'reeval')}</td>)}</tr>
                                <tr className="border-thick-top"><td rowSpan="2" className="header-main"><div className="header-main-inner"><span>Furcation</span></div></td><td className="header-sub"><div className="flex-center">Ë°ìÂâç (Pre)</div></td>{getUpperTeeth().map(id => <td key={`furc-init-${id}`}>{renderFurcationCell(id, 'initial')}</td>)}</tr>
                                <tr><td className="header-sub"><div className="flex-center">Ë°ìÂæå (Post)</div></td>{getUpperTeeth().map(id => <td key={`furc-re-${id}`}>{renderFurcationCell(id, 'reeval')}</td>)}</tr>
                                <tr className="border-thick-top"><td rowSpan="2" className="header-main"><div className="header-main-inner"><span>Buccal</span></div></td><td className="header-sub"><div className="flex-center">Êé¢Ê∏¨Ê∑±Â∫¶<br/>(Ë°ìÂâç)</div></td>{getUpperTeeth().map(id => <td key={`s1-pd-init-${id}`} className="bg-init">{renderPDInputs(id, 'buccal', 'initial')}</td>)}</tr>
                                <tr><td className="header-sub"><div className="flex-center">Êé¢Ê∏¨Ê∑±Â∫¶<br/>(Ë°ìÂæå)</div></td>{getUpperTeeth().map(id => <td key={`s1-pd-re-${id}`} className="bg-reeval">{renderPDInputs(id, 'buccal', 'reeval')}</td>)}</tr>
                                <tr className="tooth-row border-thick-top border-thick-bottom"><td colSpan="2"><div className="flex-center">Áâô‰Ωç / Tooth NO.</div></td>{getUpperTeeth().map(id => (<td key={id} className={`tooth-cell ${data[id].missing?'missing':''}`} onClick={()=>toggleMissing(id)}><div className="flex-center">{id}</div></td>))}</tr>
                                <tr><td rowSpan="2" className="header-main"><div className="header-main-inner"><span>Palatal</span></div></td><td className="header-sub"><div className="flex-center">Êé¢Ê∏¨Ê∑±Â∫¶<br/>(Ë°ìÂâç)</div></td>{getUpperTeeth().map(id => <td key={`s2-pd-init-${id}`} className="bg-init">{renderPDInputs(id, 'palatal', 'initial')}</td>)}</tr>
                                <tr><td className="header-sub"><div className="flex-center">Êé¢Ê∏¨Ê∑±Â∫¶<br/>(Ë°ìÂæå)</div></td>{getUpperTeeth().map(id => <td key={`s2-pd-re-${id}`} className="bg-reeval">{renderPDInputs(id, 'palatal', 'reeval')}</td>)}</tr>
                            </tbody>
                        </table>
                    </div>

                    <div className="chart-container">
                        <div className="bg-black text-white h-8 flex items-center px-2 border border-black text-sm justify-between">
                            <span>Mandible (‰∏ãÈ°é)</span>{renderControls(false)}
                        </div>
                        <table className="perio-table">
                            <colgroup><col className="col-header-main" /><col className="col-header-sub" />{getLowerTeeth().map(t => <col key={t} width="*" />)}</colgroup>
                            <tbody>
                                <tr className="border-thick-top"><td rowSpan="2" className="header-main"><div className="header-main-inner"><span>Lingual</span></div></td><td className="header-sub"><div className="flex-center">Êé¢Ê∏¨Ê∑±Â∫¶<br/>(Ë°ìÂâç)</div></td>{getLowerTeeth().map(id => <td key={`s1-pd-init-${id}`} className="bg-init">{renderPDInputs(id, 'buccal', 'initial')}</td>)}</tr>
                                <tr><td className="header-sub"><div className="flex-center">Êé¢Ê∏¨Ê∑±Â∫¶<br/>(Ë°ìÂæå)</div></td>{getLowerTeeth().map(id => <td key={`s1-pd-re-${id}`} className="bg-reeval">{renderPDInputs(id, 'buccal', 'reeval')}</td>)}</tr>
                                <tr className="tooth-row border-thick-top border-thick-bottom"><td colSpan="2"><div className="flex-center">Áâô‰Ωç / Tooth NO.</div></td>{getLowerTeeth().map(id => (<td key={id} className={`tooth-cell ${data[id].missing?'missing':''}`} onClick={()=>toggleMissing(id)}><div className="flex-center">{id}</div></td>))}</tr>
                                <tr><td rowSpan="2" className="header-main"><div className="header-main-inner"><span>Buccal</span></div></td><td className="header-sub"><div className="flex-center">Êé¢Ê∏¨Ê∑±Â∫¶<br/>(Ë°ìÂâç)</div></td>{getLowerTeeth().map(id => <td key={`s2-pd-init-${id}`} className="bg-init">{renderPDInputs(id, 'palatal', 'initial')}</td>)}</tr>
                                <tr><td className="header-sub"><div className="flex-center">Êé¢Ê∏¨Ê∑±Â∫¶<br/>(Ë°ìÂæå)</div></td>{getLowerTeeth().map(id => <td key={`s2-pd-re-${id}`} className="bg-reeval">{renderPDInputs(id, 'palatal', 'reeval')}</td>)}</tr>
                                <tr className="border-thick-top"><td rowSpan="2" className="header-main"><div className="header-main-inner"><span>Furcation</span></div></td><td className="header-sub"><div className="flex-center">Ë°ìÂâç (Pre)</div></td>{getLowerTeeth().map(id => <td key={`furc-init-${id}`}>{renderFurcationCell(id, 'initial')}</td>)}</tr>
                                <tr><td className="header-sub"><div className="flex-center">Ë°ìÂæå (Post)</div></td>{getLowerTeeth().map(id => <td key={`furc-re-${id}`}>{renderFurcationCell(id, 'reeval')}</td>)}</tr>
                                <tr className="border-thick-top"><td rowSpan="2" className="header-main"><div className="header-main-inner"><span>Mobility</span></div></td><td className="header-sub"><div className="flex-center">Ë°ìÂâç (Pre)</div></td>{getLowerTeeth().map(id => <td key={`mob-init-${id}`}>{renderMobilityCell(id, 'initial')}</td>)}</tr>
                                <tr><td className="header-sub"><div className="flex-center">Ë°ìÂæå (Post)</div></td>{getLowerTeeth().map(id => <td key={`mob-re-${id}`}>{renderMobilityCell(id, 'reeval')}</td>)}</tr>
                            </tbody>
                        </table>
                    </div>

                    <div className="summary-box">
                        <div className="summary-item"><span className="summary-label">Ê≤ªÁôÇÂâçÁ∏ΩÈΩíÊï∏</span><span className="summary-value">{perioStats.totalTeeth}</span></div>
                        <div className="summary-item"><span className="summary-label text-red-600">Ê≤ªÁôÇÂâçÂõäË¢ã‚âß5mmÈΩíÊï∏</span><span className="summary-value highlight">{perioStats.deepTeethInit}</span></div>
                        <div className="summary-item"><span className="summary-label text-green-700">ÊîπÂñÑÈΩíÊï∏ (‚âß2mm)</span><span className="summary-value text-green-700">{perioStats.improvedTeeth}</span></div>
                        <div className="summary-item"><span className="summary-label text-blue-800">ÊîπÂñÑÁéá</span><span className="summary-value text-blue-800">{perioStats.improvementRate}%</span></div>
                    </div>
                    <div className="clinic-footer">{clinicName}</div>
                </div>
            );

            const renderPlaqueTab = () => {
                const plaquePages = chunkArray(plaqueRecords, 2);

                return (
                    <>
                        {plaquePages.map((pageRecords, pageIdx) => (
                            <div key={pageIdx} className="a4-landscape-paper plaque-compact">
                                {pageRecords.map((record, idx) => {
                                    const stats = getPlaqueStats(record);
                                    const actualIdx = pageIdx * 2 + idx;
                                    
                                    return (
                                        <div key={record.id + '_' + idx} className="plaque-record-unit">
                                            <div className="text-center font-bold text-xl mb-1 border-b-2 border-blue-800 pb-1 text-blue-800">
                                                PLAQUE CONTROL RECORD
                                            </div>
                                            
                                            <div className="mb-2 px-2 border-b border-blue-200 pb-1">
                                                {renderPatientInfoHeader()}
                                                <div className="flex justify-between items-center text-xs font-bold text-black mt-1">
                                                    <span className="flex items-center gap-2 px-2 py-0.5">
                                                        Êó•Êúü: 
                                                        <ROCDatePicker 
                                                            value={record.date} 
                                                            onChange={(newDate) => updatePlaqueDate(actualIdx, newDate)}
                                                            theme="dark" // Using dark theme for visibility on white background
                                                            isExporting={isExporting}
                                                        />
                                                    </span>

                                                    {/* Random Plaque Controls (Hidden when exporting) */}
                                                    {!isExporting && (
                                                        <div className="flex items-center gap-2 no-print">
                                                            <span className="text-gray-600">Èö®Ê©üÁîüÊàê:</span>
                                                            <button onClick={() => handleRandomPlaque(actualIdx, 'verylow')} className="bg-gray-100 hover:bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded">ÂæÆ (10%)</button>
                                                            <button onClick={() => handleRandomPlaque(actualIdx, 'low')} className="bg-green-100 hover:bg-green-200 text-green-800 text-xs px-2 py-1 rounded">‰Ωé (20%)</button>
                                                            <button onClick={() => handleRandomPlaque(actualIdx, 'medium')} className="bg-yellow-100 hover:bg-yellow-200 text-yellow-800 text-xs px-2 py-1 rounded">‰∏≠ (50%)</button>
                                                            <button onClick={() => handleRandomPlaque(actualIdx, 'high')} className="bg-red-100 hover:bg-red-200 text-red-800 text-xs px-2 py-1 rounded">È´ò (80%)</button>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>

                                            <div className="summary-box mb-2">
                                                <div className="summary-item"><span className="summary-label">ÁèæÊúâÁâôÈΩíÁ∏ΩÊï∏</span><span className="summary-value">{stats.totalTeeth}</span></div>
                                                <div className="summary-item"><span className="summary-label">Á∏ΩÊ™¢Ê∏¨Èù¢Êï∏</span><span className="summary-value">{stats.totalSites}</span></div>
                                                <div className="summary-item"><span className="summary-label">ÁâôËèåÊñëÈù¢Êï∏</span><span className="summary-value">{stats.plaqueSites}</span></div>
                                                <div className="summary-item"><span className="summary-label text-blue-800">ÁâôËèåÊñëÊåáÊï∏ (PCR)</span><span className={`summary-value ${stats.index > 20 ? 'highlight' : 'text-blue-800'}`}>{stats.index}%</span></div>
                                            </div>

                                            <div className="chart-container">
                                                <div className="bg-blue-800 text-white h-7 flex items-center justify-between px-2 text-xs font-bold rounded-t mb-0.5">
                                                    <span>Maxilla (‰∏äÈ°é)</span>{renderControls(true)}
                                                </div>
                                                <table className="perio-table">
                                                    <colgroup><col width="130" />{getUpperTeeth().map(t => <col key={t} width="*" />)}</colgroup>
                                                    <tbody>
                                                        <tr><td className="header-sub font-bold text-blue-600"><div className="flex-center">Buccal (È†∞)</div></td>{getUpperTeeth().map(id => <td key={`s1-plq-${id}`}>{renderPlaqueRow(actualIdx, id, 'buccal')}</td>)}</tr>
                                                        <tr className="tooth-row border-thick-top border-thick-bottom" style={{backgroundColor: '#1e40af'}}><td><div className="flex-center">Áâô‰Ωç / NO.</div></td>{getUpperTeeth().map(id => (<td key={id} className={`tooth-cell ${plaqueRecords[actualIdx].data[id].missing ? 'missing' : ''}`} onClick={()=>togglePlaqueMissing(actualIdx, id)}><div className="flex-center">{id}</div></td>))}</tr>
                                                        <tr><td className="header-sub font-bold text-blue-600"><div className="flex-center">Palatal (È°é)</div></td>{getUpperTeeth().map(id => <td key={`s2-plq-${id}`}>{renderPlaqueRow(actualIdx, id, 'palatal')}</td>)}</tr>
                                                    </tbody>
                                                </table>
                                            </div>

                                            <div className="chart-container">
                                                <div className="bg-blue-800 text-white h-7 flex items-center justify-between px-2 text-xs font-bold rounded-t mb-0.5">
                                                    <span>Mandible (‰∏ãÈ°é)</span>{renderControls(false)}
                                                </div>
                                                <table className="perio-table">
                                                    <colgroup><col width="130" />{getLowerTeeth().map(t => <col key={t} width="*" />)}</colgroup>
                                                    <tbody>
                                                        <tr><td className="header-sub font-bold text-blue-600"><div className="flex-center">Lingual (Ëàå)</div></td>{getLowerTeeth().map(id => <td key={`s1-plq-${id}`}>{renderPlaqueRow(actualIdx, id, 'buccal')}</td>)}</tr>
                                                        <tr className="tooth-row border-thick-top border-thick-bottom" style={{backgroundColor: '#1e40af'}}><td><div className="flex-center">Áâô‰Ωç / NO.</div></td>{getLowerTeeth().map(id => (<td key={id} className={`tooth-cell ${plaqueRecords[actualIdx].data[id].missing ? 'missing' : ''}`} onClick={()=>togglePlaqueMissing(actualIdx, id)}><div className="flex-center">{id}</div></td>))}</tr>
                                                        <tr><td className="header-sub font-bold text-blue-600"><div className="flex-center">Buccal (È†∞)</div></td>{getLowerTeeth().map(id => <td key={`s2-plq-${id}`}>{renderPlaqueRow(actualIdx, id, 'palatal')}</td>)}</tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ))}
                        <div className="flex justify-center mt-6 no-print">
                            <button onClick={addNewPlaqueRecord} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg flex items-center gap-2">
                                <span>‚ûï Êñ∞Â¢û‰∏ã‰∏ÄÊ¨°ÁâôËèåÊñëÁ¥ÄÈåÑ</span>
                            </button>
                        </div>
                    </>
                );
            };

            return (
                <div className="min-h-screen">
                    {/* Start Modal */}
                    {!isStarted && (
                        <div className="login-overlay">
                            <div className="login-box">
                                <h2 className="text-2xl font-bold mb-6 text-gray-800">Ë´ãÈÅ∏ÊìáË®∫ÊâÄ</h2>
                                
                                <div className="space-y-3 mb-6">
                                    <button 
                                        className={`clinic-btn ${clinicName === 'Ê°ÉÂúíÁ´ãÊΩîÁâôÈÜ´Ë®∫ÊâÄ' ? 'selected' : ''}`}
                                        onClick={() => setClinicName('Ê°ÉÂúíÁ´ãÊΩîÁâôÈÜ´Ë®∫ÊâÄ')}
                                    >
                                        Ê°ÉÂúíÁ´ãÊΩîÁâôÈÜ´Ë®∫ÊâÄ
                                    </button>
                                    <button 
                                        className={`clinic-btn ${clinicName === 'Êñ∞ËéäÂêõÊÇÖÁâôÈÜ´Ë®∫ÊâÄ' ? 'selected' : ''}`}
                                        onClick={() => setClinicName('Êñ∞ËéäÂêõÊÇÖÁâôÈÜ´Ë®∫ÊâÄ')}
                                    >
                                        Êñ∞ËéäÂêõÊÇÖÁâôÈÜ´Ë®∫ÊâÄ
                                    </button>
                                    <button 
                                        className={`clinic-btn ${clinicName === 'ÊÅÜÁæéÁâôÈÜ´Ë®∫ÊâÄ' ? 'selected' : ''}`}
                                        onClick={() => setClinicName('ÊÅÜÁæéÁâôÈÜ´Ë®∫ÊâÄ')}
                                    >
                                        ÊÅÜÁæéÁâôÈÜ´Ë®∫ÊâÄ
                                    </button>
                                    <button 
                                        className={`clinic-btn ${clinicName === 'other' ? 'selected' : ''}`}
                                        onClick={() => setClinicName('other')}
                                    >
                                        ÂÖ∂‰ªñË®∫ÊâÄ
                                    </button>
                                    
                                    {clinicName === 'other' && (
                                        <input 
                                            type="text" 
                                            className="border-2 border-blue-500 rounded p-2 text-lg w-full text-center mt-2"
                                            placeholder="Ë´ãËº∏ÂÖ•Ë®∫ÊâÄÂêçÁ®±"
                                            value={customClinicName}
                                            onChange={e => setCustomClinicName(e.target.value)}
                                        />
                                    )}
                                </div>

                                <button onClick={handleStart} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full w-full text-lg mb-4 shadow-lg">
                                    ÈÄ≤ÂÖ•Á≥ªÁµ±
                                </button>
                                
                                <div className="border-t pt-4">
                                    <button onClick={handleOpenFile} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg w-full flex items-center justify-center gap-2 shadow">
                                        üìÇ ÈñãÂïüËàäÊ™î
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className={`toast ${toastMsg ? 'show' : ''}`}>{toastMsg}</div>

                    {isStarted && (
                        <>
                            <div className="w-full max-w-[1400px] bg-white p-5 rounded-lg shadow-md mb-6 flex flex-col gap-4 border border-gray-200 mx-auto mt-6 no-print">
                                {/* ... Controls ... */}
                                <div className="flex justify-between items-center border-b pb-4">
                                    <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                        {activeTab === 'chart' ? 'ü¶∑ ÁâôÂë®Ê≤ªÁôÇÁ¥ÄÈåÑË°®' : 'ü¶† ÁâôËèåÊñëÊéßÂà∂Á¥ÄÈåÑË°®'}
                                        <span className="text-xs font-normal text-white bg-green-600 px-2 py-1 rounded">Input Fix & Random 10%</span>
                                    </h1>
                                    <div className="flex gap-2 items-center">
                                        <span className="text-sm font-bold text-gray-500">{clinicName}</span>
                                        {/* Local File Save Button */}
                                        <button onClick={() => handleSaveFile(false)} className="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-bold flex items-center gap-1">
                                            üíæ ÂÑ≤Â≠òÊ™îÊ°à
                                        </button>
                                        <button onClick={handleNewRecord} className="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm font-bold flex items-center gap-1">
                                            üìÑ ÈñãÊñ∞Ê™îÊ°à
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Êì¥ÂÖÖÁöÑËº∏ÂÖ•Ê¨Ñ‰Ωç */}
                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 items-end">
                                    {/* ... Input Fields (Same as before) ... */}
                                     <div className="flex flex-col">
                                        <label className="text-xs font-bold text-gray-500 mb-1">ÁóÖÊ≠∑Ëôü (Chart No)</label>
                                        <input className="border-2 border-blue-200 rounded px-3 py-2 text-lg font-bold text-blue-900 focus:outline-none focus:border-blue-500" 
                                               type="tel" inputMode="numeric" value={patientInfo.id} onChange={e=>setPatientInfo({...patientInfo, id: e.target.value})} />
                                    </div>
                                    <div className="flex flex-col"><label className="text-xs font-bold text-gray-500 mb-1">ÂßìÂêç</label><input className="border border-gray-300 rounded px-3 py-2" value={patientInfo.name} onChange={e=>setPatientInfo({...patientInfo, name: e.target.value})} /></div>
                                    <div className="flex flex-col"><label className="text-xs font-bold text-gray-500 mb-1">Ë∫´‰ªΩË≠âÂ≠óËôü</label><input className="border border-gray-300 rounded px-3 py-2" value={patientInfo.idNumber} onChange={e=>setPatientInfo({...patientInfo, idNumber: e.target.value})} /></div>
                                    <div className="flex flex-col"><label className="text-xs font-bold text-gray-500 mb-1">ÊÄßÂà•</label><select className="border border-gray-300 rounded px-3 py-2 bg-white" value={patientInfo.gender} onChange={e=>setPatientInfo({...patientInfo, gender: e.target.value})}><option value="">Ë´ãÈÅ∏Êìá</option><option value="Áî∑">Áî∑</option><option value="Â•≥">Â•≥</option></select></div>
                                    
                                    {/* ROC DOB */}
                                    <div className="flex flex-col">
                                        <label className="text-xs font-bold text-gray-500 mb-1">ÁîüÊó•</label>
                                        <ROCDatePicker 
                                            value={patientInfo.dob} 
                                            onChange={(newDate) => setPatientInfo({...patientInfo, dob: newDate})} 
                                            theme="dark" // White bg -> dark text
                                        />
                                    </div>

                                    <div className="flex flex-col"><label className="text-xs font-bold text-gray-500 mb-1">Âπ¥ÈΩ°</label><input type="number" className="border border-gray-300 rounded px-3 py-2" value={patientInfo.age} onChange={e=>setPatientInfo({...patientInfo, age: e.target.value})} /></div>
                                    <div className="flex flex-col"><label className="text-xs font-bold text-gray-500 mb-1">‰∏ªÊ≤ªÈÜ´Â∏´</label><input className="border border-gray-300 rounded px-3 py-2" value={patientInfo.doctor} onChange={e=>setPatientInfo({...patientInfo, doctor: e.target.value})} /></div>
                                    
                                    {/* ROC Dates */}
                                    <div className="flex flex-col">
                                        <label className="text-xs font-bold text-gray-500 mb-1">Ë°ìÂâçÊó•Êúü</label>
                                        <ROCDatePicker 
                                            value={patientInfo.datePre} 
                                            onChange={(newDate) => setPatientInfo({...patientInfo, datePre: newDate})} 
                                            theme="dark"
                                        />
                                    </div>
                                    <div className="flex flex-col">
                                        <label className="text-xs font-bold text-gray-500 mb-1">Ë°ìÂæåÊó•Êúü</label>
                                        <ROCDatePicker 
                                            value={patientInfo.datePost} 
                                            onChange={(newDate) => setPatientInfo({...patientInfo, datePost: newDate})} 
                                            theme="dark"
                                        />
                                    </div>
                                </div>
                                
                                {/* Download Buttons Section */}
                                <div className="flex gap-2 mt-4 border-t pt-4">
                                    <button onClick={() => downloadPDF('a4')} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-bold shadow flex items-center gap-2 text-sm">
                                        <span>ÈñãÂïü A4 PDF</span>
                                    </button>
                                    <button onClick={() => downloadPDF('a5')} className="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded font-bold shadow flex items-center gap-2 text-sm">
                                        <span>ÈñãÂïü A5 PDF</span>
                                    </button>
                                    <button onClick={() => downloadPDF('jpg_a4')} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold shadow flex items-center gap-2 text-sm">
                                        <span>ÈñãÂïü JPG (A4)</span>
                                    </button>
                                    <button onClick={() => downloadPDF('jpg_a5')} className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-bold shadow flex items-center gap-2 text-sm">
                                        <span>ÈñãÂïü JPG (A5)</span>
                                    </button>
                                </div>
                            </div>

                            <div className="w-full max-w-[297mm] flex pl-2 mx-auto no-print">
                                <button className={`tab-btn ${activeTab === 'chart' ? 'active' : 'inactive'}`} onClick={() => setActiveTab('chart')}>ÁâôÂë®Á¥ÄÈåÑË°®</button>
                                <button className={`tab-btn ${activeTab === 'plaque' ? 'active' : 'inactive'}`} onClick={() => setActiveTab('plaque')}>ÁâôËèåÊñëÁ¥ÄÈåÑË°®</button>
                            </div>

                            <div ref={chartRef} className="w-full flex flex-col items-center">
                                {activeTab === 'chart' ? renderPerioTab() : renderPlaqueTab()}
                            </div>
                        </>
                    )}

                    {previewImg && (
                        <div className="modal-overlay" onClick={() => setPreviewImg(null)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold">üñ®Ô∏è ÂàóÂç∞È†êË¶Ω</h3>
                                    <div className="flex gap-2">
                                        <button onClick={() => downloadPDF('a4')} className="bg-red-600 text-white px-3 py-1 rounded text-sm font-bold hover:bg-red-700">A4 PDF</button>
                                        <button onClick={() => downloadPDF('a5')} className="bg-orange-600 text-white px-3 py-1 rounded text-sm font-bold hover:bg-orange-700">A5 PDF</button>
                                        <button onClick={() => downloadPDF('jpg_a4')} className="bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold hover:bg-blue-700">JPG (A4)</button>
                                        <button onClick={() => setPreviewImg(null)} className="bg-gray-500 text-white px-3 py-1 rounded text-sm font-bold hover:bg-gray-600">ÈóúÈñâ</button>
                                    </div>
                                </div>
                                <img src={previewImg} alt="Preview" className="preview-img" />
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
